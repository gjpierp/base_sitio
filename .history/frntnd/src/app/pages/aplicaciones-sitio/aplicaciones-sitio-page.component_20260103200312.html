<div class="page-animate" [class.page-ready]="datosListos">
  <ui-card [title]="title" [subtitle]="subtitle">
    <div
      class="spread"
      style="margin-bottom: 1rem; align-items: center; display: flex; gap: 0.5rem"
    >
      @if(loading){
      <ng-container>
        <ui-spinner label="Cargando"></ui-spinner>
      </ng-container>
      } @if(!loading && error){
      <ng-container>
        <div class="muted">{{ error }}</div>
      </ng-container>
      } @if(!loading){
      <ng-container>
        <div style="margin-left: auto">
          <button type="button" class="btn primary" (click)="openCreateModal()">Crear</button>
        </div>
      </ng-container>
      }
    </div>

    @if(!loading && datosListos){
    <ng-container>
      <ui-entity-table
        [title]="title"
        [subtitle]="subtitle"
        [columns]="columns"
        [data]="data"
        [loading]="loading"
        [error]="error"
        (edit)="onEdit($event)"
        (remove)="onRemove($event)"
      ></ui-entity-table>
    </ng-container>
    }
  </ui-card>
</div>

<!-- Modal integrado para creación/edición -->
<ui-modal
  [open]="modalOpen"
  [title]="modalTitle"
  (confirmed)="onModalConfirm()"
  (closed)="onModalClosed()"
>
  <div class="content">
    @if(modalFields.length){
    <form (submit)="$event.preventDefault(); onModalConfirm()">
      <table class="form-table">
        @for(let f of modalFields){
        <tr>
          <th>
            <label [for]="f.key">{{ f.label }}</label>
          </th>
          <td>
            <ng-container [ngSwitch]="f.type">
              @switchCase('text'){
              <input [id]="f.key" [(ngModel)]="modalValues[f.key]" [name]="f.key" />
              } @switchCase('select'){
              <select [id]="f.key" [(ngModel)]="modalValues[f.key]" [name]="f.key">
                <option *ngFor="let o of f.options || []" [value]="o.value">{{ o.label }}</option>
              </select>
              } @switchCase('textarea'){
              <textarea [id]="f.key" [(ngModel)]="modalValues[f.key]" [name]="f.key"></textarea>
              } @switchDefault{
              <input [id]="f.key" [(ngModel)]="modalValues[f.key]" [name]="f.key" />
              }
            </ng-container>
          </td>
        </tr>
        }
      </table>
    </form>
    }
  </div>
</ui-modal>

<div style="margin-top: 1rem">
  <details>
    <summary>Debug estado (mostrar/ocultar)</summary>
    <pre style="font-size: 12px; white-space: pre-wrap; margin-top: 0.5rem">{{
      {
        loading: loading,
        datosListos: datosListos,
        dataLength: (data || []).length,
        total: total,
        error: error
      } | json
    }}</pre>
  </details>
</div>
