const fs = require('fs');
const path = require('path');

const workspaceRoot = path.resolve(__dirname, '..');
const srcDir = path.join(workspaceRoot, 'src');
const themesDir = path.join(srcDir, 'assets', 'design-system', 'themes');

function walk(dir, exts, excludePredicate, results = []) {
  const items = fs.readdirSync(dir, { withFileTypes: true });
  for (const it of items) {
    const p = path.join(dir, it.name);
    if (it.isDirectory()) {
      if (excludePredicate && excludePredicate(p)) continue;
      walk(p, exts, excludePredicate, results);
    } else {
      const ext = path.extname(it.name).toLowerCase();
      if (exts.includes(ext)) results.push(p);
    }
  }
  return results;
}

function findHexesInFiles(files) {
  const hexRe = /#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})\b/g;
  const set = new Set();
  for (const f of files) {
    const txt = fs.readFileSync(f, 'utf8');
    let m;
    while ((m = hexRe.exec(txt))) {
      set.add('#' + m[1].toLowerCase());
    }
  }
  return Array.from(set).sort();
}

function appendVarsToTheme(themeFile, hexes) {
  const original = fs.readFileSync(themeFile, 'utf8');
  const varsNeeded = hexes.filter((h) => !new RegExp(`--c-${h.slice(1)}`, 'i').test(original));
  if (varsNeeded.length === 0) return false;

  const backup = themeFile + '.bak';
  if (!fs.existsSync(backup)) fs.writeFileSync(backup, original, 'utf8');

  const lines = [
    '\n/* auto-generated color variables (generated by generate-theme-color-variables.js) */',
    ':root {',
  ];
  for (const h of varsNeeded) {
    const name = `--c-${h.slice(1).toLowerCase()}`;
    lines.push(`  ${name}: ${h};`);
  }
  lines.push('}');

  const out = original + '\n' + lines.join('\n') + '\n';
  fs.writeFileSync(themeFile, out, 'utf8');
  return true;
}

function main() {
  if (!fs.existsSync(srcDir)) {
    console.error('Cannot find src directory:', srcDir);
    process.exit(1);
  }

  const componentFiles = walk(srcDir, ['.css', '.scss'], (p) =>
    p.includes(path.join('assets', 'design-system', 'themes'))
  );
  const hexes = findHexesInFiles(componentFiles);

  if (hexes.length === 0) {
    console.log('No hex color literals found in component files. Nothing to do.');
    return;
  }

  console.log('Found', hexes.length, 'unique hex codes. Example:', hexes.slice(0, 6));

  if (!fs.existsSync(themesDir)) {
    console.error('Themes directory not found:', themesDir);
    process.exit(1);
  }

  const themes = fs.readdirSync(themesDir).filter((n) => n.endsWith('.css'));
  let changed = 0;
  for (const t of themes) {
    const tf = path.join(themesDir, t);
    const ok = appendVarsToTheme(tf, hexes);
    if (ok) {
      console.log('Updated theme:', t);
      changed++;
    }
  }

  console.log(`Done. Themes updated: ${changed}. Variables added for ${hexes.length} colors.`);
}

main();
