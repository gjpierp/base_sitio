<form (ngSubmit)="aplicarFiltros()" style="margin-bottom: 0">
  <ui-card class="spread" style="align-items: center; margin-bottom: 1rem">
    <div style="display: flex; align-items: center; justify-content: space-between">
      <div>
        <span style="font-size: 1.5em; font-weight: 600">{{ title }}</span>
        <span *ngIf="subtitle" style="margin-left: 1rem; color: #888; font-size: 1em">{{
          subtitle
        }}</span>
      </div>
      <ui-button
        variant="primary"
        (pressed)="openCreateModal()"
        icon="add"
        [iconOnly]="true"
        ariaLabel="Crear"
      ></ui-button>
    </div>
  </ui-card>
  <ui-card title="Filtros" style="margin-bottom: 1rem">
    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center">
      <input
        type="text"
        [(ngModel)]="filtroNombre"
        name="filtroNombre"
        placeholder="Nombre"
        style="width: 180px"
      />
      <input
        type="text"
        [(ngModel)]="filtroCodigo"
        name="filtroCodigo"
        placeholder="Código"
        style="width: 180px"
      />
      <select [(ngModel)]="filtroEstado" name="filtroEstado" style="width: 160px">
        <option value="">Todos los estados</option>
        <option *ngFor="let e of estados" [value]="e.id_estado">{{ e.nombre }}</option>
      </select>
    </div>

    <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 1rem">
      <ui-button
        type="submit"
        variant="primary"
        icon="search"
        [iconOnly]="true"
        ariaLabel="Buscar"
        title="Buscar"
      ></ui-button>
      <ui-button
        type="button"
        variant="primary"
        icon="clear"
        [iconOnly]="true"
        ariaLabel="Limpiar"
        title="Limpiar"
        (pressed)="limpiarFiltros()"
      ></ui-button>
    </div>
  </ui-card>
  <ui-card>
    <ui-entity-table
      [title]="title"
      [subtitle]="subtitle"
      [columns]="columns"
      [data]="formattedData"
      [total]="total"
      [loading]="loading"
      [error]="error"
      [page]="currentPage"
      [pageSize]="pageSize"
      [pageSizeOptions]="pageSizeOptions"
      (edit)="onEdit($event)"
      (remove)="onRemove($event)"
      (pageChange)="onPageChange($event)"
      (pageSizeChange)="onPageSizeChange($event)"
    ></ui-entity-table>
  </ui-card>
</form>

<!-- Modal integrado para creación/edición/eliminación -->
<ui-modal
  #modalRef
  [isOpen]="modalOpen"
  [title]="modalTitle"
  (confirmed)="onModalConfirm()"
  (closed)="onModalClosed()"
>
  <div class="content">
    <div *ngIf="modalLoading" style="display: flex; justify-content: center; padding: 1rem">
      <ui-spinner label="Cargando"></ui-spinner>
    </div>
    <div *ngIf="!modalLoading && modalError" style="color: #c00; padding: 1rem; text-align: center">
      {{ modalError }}
    </div>
    <!-- Mensaje de confirmación de eliminación -->
    <div
      *ngIf="!modalLoading && modalDeleteMode"
      style="padding: 2rem; text-align: center; font-size: 1.1em"
    >
      <span>
        ¿Estás seguro que deseas eliminar el sitio <b>{{ modalValues.nombre || '' }}</b
        >?
      </span>
    </div>
    <table class="form-table" *ngIf="!modalLoading && !modalDeleteMode && modalFields.length">
      <ng-container *ngFor="let f of modalFields">
        <tr *ngIf="!f.hidden">
          <th>
            <label
              [for]="f.key"
              style="
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 220px;
                display: inline-block;
              "
              >{{ f.label }}</label
            >
          </th>
          <td>
            <ng-container [ngSwitch]="f.type">
              <ng-container *ngSwitchCase="'text'">
                <input
                  [id]="f.key"
                  [(ngModel)]="modalValues[f.key]"
                  [name]="f.key"
                  [readonly]="f.readonly"
                  style="width: 420px; max-width: 100%; box-sizing: border-box"
                />
              </ng-container>
              <ng-container *ngSwitchCase="'select'">
                <select
                  [id]="f.key"
                  [(ngModel)]="modalValues[f.key]"
                  [name]="f.key"
                  [disabled]="f.readonly"
                  style="width: 420px; max-width: 100%; box-sizing: border-box"
                >
                  <option *ngFor="let o of f.options || []" [value]="o.value">
                    {{ o.label }}
                  </option>
                </select>
              </ng-container>
              <ng-container *ngSwitchCase="'textarea'">
                <textarea
                  [id]="f.key"
                  [(ngModel)]="modalValues[f.key]"
                  [name]="f.key"
                  [readonly]="f.readonly"
                  style="width: 420px; max-width: 100%; box-sizing: border-box"
                ></textarea>
              </ng-container>
              <ng-container *ngSwitchDefault>
                <input
                  [id]="f.key"
                  [(ngModel)]="modalValues[f.key]"
                  [name]="f.key"
                  [readonly]="f.readonly"
                  style="width: 420px; max-width: 100%; box-sizing: border-box"
                />
              </ng-container>
            </ng-container>
          </td>
        </tr>
      </ng-container>
    </table>
  </div>
</ui-modal>
